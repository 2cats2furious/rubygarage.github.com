<section id="example-migration" class="slide">
  <h2>Example Migration</h2>

  <script type="syntaxhighlighter" class="brush: ruby">
    class ExampleMigration < ActiveRecord::Migration
      def up
        create_table :users do |t|
          t.references :group
        end
        #add a foreign key
        execute <<-SQL
          ALTER TABLE products
            ADD CONSTRAINT fk_users_groups
            FOREIGN KEY (group_id)
            REFERENCES groups(id)
        SQL
        add_column :users, :home_page_url, :string
        rename_column :users, :email, :email_address
      end

      def down
        rename_column :users, :email_address, :email
        remove_column :users, :home_page_url
        execute <<-SQL
          ALTER TABLE users
            DROP FOREIGN KEY fk_users_groups
        SQL
        drop_table :users
      end
    end
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    class ExampleMigration < ActiveRecord::Migration[5.0]
      def change
        create_table :distributors do |t|
          t.string :zipcode
        end

        reversible do |dir|
          dir.up do
            # add a CHECK constraint
            execute <<-SQL
              ALTER TABLE distributors
                ADD CONSTRAINT zipchk
                  CHECK (char_length(zipcode) = 5) NO INHERIT;
            SQL
          end
          dir.down do
            execute <<-SQL
              ALTER TABLE distributors
                DROP CONSTRAINT zipchk
            SQL
          end
        end

        add_column :users, :home_page_url, :string
        rename_column :users, :email, :email_address
      end
    end
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    require_relative '20121212123456_example_migration'

    class FixupExampleMigration < ActiveRecord::Migration[5.0]
      def change
        revert ExampleMigration

        create_table(:apples) do |t|
          t.string :variety
        end
      end
    end
  </script>

  <script type="syntaxhighlighter" class="brush: ruby">
    class DontUseConstraintForZipcodeValidationMigration < ActiveRecord::Migration[5.0]
      def change
        revert do
          # copy-pasted code from ExampleMigration
          reversible do |dir|
            dir.up do
              # add a CHECK constraint
              execute <<-SQL
                ALTER TABLE distributors
                  ADD CONSTRAINT zipchk
                    CHECK (char_length(zipcode) = 5);
              SQL
            end
            dir.down do
              execute <<-SQL
                ALTER TABLE distributors
                  DROP CONSTRAINT zipchk
              SQL
            end
          end

          # The rest of the migration was ok
        end
      end
    end
  </script>
</section>
